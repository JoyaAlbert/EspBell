<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EspBell MQTT</title>
  <style>
    :root {
      /* Variables de color en estilo Apple - Tema Claro */
      --apple-bg: #f5f5f7;
      --apple-panel: rgba(255, 255, 255, 0.8);
      --apple-panel-solid: #ffffff;
      --apple-text: #1d1d1f;
      --apple-text-secondary: #86868b;
      --apple-accent: #0071e3;
      --apple-accent-hover: #0077ed;
      --apple-accent-light: rgba(0, 113, 227, 0.1);
      --apple-border: rgba(0, 0, 0, 0.1);
      --apple-success: #34c759;
      --apple-warning: #ff9f0a;
      --apple-error: #ff3b30;
      --apple-inactive: #ebebeb;
      --apple-shadow: rgba(0, 0, 0, 0.08);
      --apple-shadow-strong: rgba(0, 0, 0, 0.15);
      --apple-radius: 12px;
      --apple-radius-button: 980px;
      --apple-transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    /* Variables de tema oscuro */
    .dark-theme {
      --apple-bg: #1d1d1f;
      --apple-panel: rgba(40, 40, 45, 0.8);
      --apple-panel-solid: #2a2a2e;
      --apple-text: #f5f5f7;
      --apple-text-secondary: #aaaaae;
      --apple-accent: #0a84ff;
      --apple-accent-hover: #409cff;
      --apple-accent-light: rgba(10, 132, 255, 0.15);
      --apple-border: rgba(255, 255, 255, 0.1);
      --apple-inactive: #3a3a3c;
      --apple-shadow: rgba(0, 0, 0, 0.3);
      --apple-shadow-strong: rgba(0, 0, 0, 0.5);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--apple-bg);
      background-image: linear-gradient(to bottom, var(--apple-bg), var(--apple-bg) 95%);
      color: var(--apple-text);
      margin: 0;
      padding: 30px;
      overflow-x: hidden;
      line-height: 1.47059;
      font-weight: 400;
      letter-spacing: -0.022em;
      min-height: 100vh;
      box-sizing: border-box;
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--apple-panel-solid);
      padding: 30px;
      border-radius: var(--apple-radius);
      box-shadow: 0 8px 32px var(--apple-shadow), 0 2px 8px var(--apple-shadow);
      border: 1px solid var(--apple-border);
      transition: var(--apple-transition);
    }
    
    h1 {
      color: var(--apple-text);
      text-align: center;
      margin-bottom: 24px;
      font-weight: 600;
      font-size: 32px;
      letter-spacing: -0.03em;
    }
    
    h3 {
      font-weight: 500;
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 16px 20px;
      border-radius: var(--apple-radius);
      background-color: var(--apple-panel-solid);
      border: 1px solid var(--apple-border);
      box-shadow: 0 2px 6px var(--apple-shadow);
      transition: var(--apple-transition);
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      transition: var(--apple-transition);
    }
    
    .status-indicator.connected {
      background-color: var(--apple-success);
      box-shadow: 0 0 8px rgba(52, 199, 89, 0.5);
    }
    
    .status-indicator.disconnected {
      background-color: var(--apple-error);
      box-shadow: 0 0 8px rgba(255, 59, 48, 0.5);
    }
    
    .status-indicator.reconnecting {
      background-color: var(--apple-warning);
      box-shadow: 0 0 8px rgba(255, 159, 10, 0.5);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .broker-config {
      margin-bottom: 24px;
      padding: 24px;
      border-radius: var(--apple-radius);
      background-color: var(--apple-panel-solid);
      border: 1px solid var(--apple-border);
      box-shadow: 0 2px 6px var(--apple-shadow);
      transition: var(--apple-transition);
    }
    
    .broker-config:hover, .publish-container:hover, .connection-status:hover {
      box-shadow: 0 4px 12px var(--apple-shadow-strong);
      transform: translateY(-2px);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--apple-text);
      font-size: 14px;
    }
    
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--apple-border);
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 15px;
      transition: var(--apple-transition);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-color: var(--apple-panel-solid);
    }
    
    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: var(--apple-accent);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.25);
    }
    
    button {
      background-color: var(--apple-accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--apple-radius-button);
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: var(--apple-transition);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      letter-spacing: -0.01em;
      box-shadow: 0 2px 6px rgba(0, 113, 227, 0.3);
    }
    
    button:hover {
      background-color: var(--apple-accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 113, 227, 0.4);
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 113, 227, 0.2);
    }
    
    button:disabled {
      background-color: var(--apple-inactive);
      color: var(--apple-text-secondary);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .secondary-button {
      background-color: transparent;
      color: var(--apple-accent);
      border: 1px solid var(--apple-accent);
      box-shadow: none;
    }
    
    .secondary-button:hover {
      background-color: var(--apple-accent-light);
      box-shadow: none;
    }
    
    .danger-button {
      background-color: var(--apple-error);
      box-shadow: 0 2px 6px rgba(255, 59, 48, 0.3);
    }
    
    .danger-button:hover {
      background-color: #ff514a;
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
    }
    
    .messages-container {
      margin-top: 24px;
    }
    
    .message-list {
      height: 250px;
      overflow-y: auto;
      border: 1px solid var(--apple-border);
      border-radius: var(--apple-radius);
      padding: 16px;
      margin-bottom: 20px;
      background-color: var(--apple-panel-solid);
      box-shadow: inset 0 1px 3px var(--apple-shadow);
    }
    
    .message-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--apple-border);
      font-size: 14px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      transition: var(--apple-transition);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .message-item:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .message-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .message-item .topic {
      font-weight: 600;
      color: var(--apple-text);
    }
    
    .message-item .timestamp {
      color: var(--apple-text-secondary);
      font-size: 12px;
      margin-left: 10px;
    }
    
    .publish-container {
      margin-top: 24px;
      padding: 24px;
      border-radius: var(--apple-radius);
      background-color: var(--apple-panel-solid);
      border: 1px solid var(--apple-border);
      box-shadow: 0 2px 6px var(--apple-shadow);
      transition: var(--apple-transition);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--apple-border);
      gap: 4px;
      position: relative;
    }
    
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: var(--apple-text-secondary);
      transition: var(--apple-transition);
      position: relative;
      z-index: 1;
      border-radius: 8px 8px 0 0;
    }
    
    .tab:hover {
      color: var(--apple-accent);
    }
    
    .tab.active {
      color: var(--apple-accent);
      font-weight: 600;
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 10%;
      width: 80%;
      height: 2px;
      background-color: var(--apple-accent);
      border-radius: 1px;
      transition: var(--apple-transition);
    }
    
    .tab-content {
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: var(--apple-transition);
    }
    
    .tab-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
      animation: fadeIn 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    }
    
    .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 13px;
      color: var(--apple-text-secondary);
      padding-top: 20px;
      border-top: 1px solid var(--apple-border);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Inputs group con botón al lado */
    .input-group {
      display: flex;
      gap: 12px;
    }
    
    .input-group input {
      flex: 1;
    }
    
    /* Personalización de la barra de desplazamiento */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--apple-border);
      border-radius: 4px;
      border: 2px solid var(--apple-panel-solid);
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--apple-text-secondary);
    }

    /* Notificación flotante */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 16px;
      background-color: var(--apple-panel-solid);
      border-radius: var(--apple-radius);
      box-shadow: 0 4px 16px var(--apple-shadow-strong);
      border: 1px solid var(--apple-border);
      display: flex;
      align-items: center;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
      z-index: 100;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .notification.success {
      border-left: 4px solid var(--apple-success);
    }

    .notification.error {
      border-left: 4px solid var(--apple-error);
    }

    .notification .message {
      margin-left: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .version-info {
      display: inline-flex;
      align-items: center;
      font-size: 12px;
      color: var(--apple-text-secondary);
      background-color: var(--apple-panel-solid);
      padding: 4px 10px;
      border-radius: 16px;
      margin: 0 auto;
      box-shadow: 0 1px 3px var(--apple-shadow);
    }

    /* Animación para la carga de la página */
    @keyframes appearFromBottom {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .container {
      animation: appearFromBottom 0.8s cubic-bezier(0.19, 1, 0.22, 1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>EspBell MQTT Client</h1>
    <div class="version-info">
      <span id="version-number"></span> • <span id="platform-name"></span>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="connection">Conexión</div>
      <div class="tab" data-tab="messages">Mensajes</div>
      <div class="tab" data-tab="publish">Publicar</div>
    </div>
    
    <div class="tab-content active" id="connection-tab">
      <div class="connection-status">
        <div>
          <span class="status-indicator disconnected" id="status-indicator"></span>
          <span id="connection-status">Desconectado</span>
        </div>
        <div>
          <button id="disconnect-btn" class="danger-button" disabled>Desconectar</button>
        </div>
      </div>
      
      <div class="broker-config">
        <h3>Configuración del Broker</h3>
        <div class="form-group">
          <label for="broker-url">URL del Broker:</label>
          <input type="text" id="broker-url" placeholder="mqtt://broker.emqx.io:1883" value="mqtt://broker.emqx.io:1883">
        </div>
        <div class="form-group">
          <label for="broker-username">Usuario (opcional):</label>
          <input type="text" id="broker-username" placeholder="Usuario">
        </div>
        <div class="form-group">
          <label for="broker-password">Contraseña (opcional):</label>
          <input type="password" id="broker-password" placeholder="Contraseña">
        </div>
        <button id="connect-btn">Conectar</button>
      </div>
    </div>
    
    <div class="tab-content" id="messages-tab">
      <div class="messages-container">
        <h3>Mensajes Recibidos</h3>
        <div class="form-group">
          <label for="subscription-topic">Tema de suscripción:</label>
          <div class="input-group">
            <input type="text" id="subscription-topic" placeholder="espbell/commands" value="espbell/commands">
            <button id="subscribe-btn">Suscribir</button>
          </div>
        </div>
        <div class="message-list" id="message-list">
          <!-- Los mensajes se agregarán aquí dinámicamente -->
        </div>
        <button id="clear-messages-btn" class="secondary-button">Limpiar Mensajes</button>
      </div>
    </div>
    
    <div class="tab-content" id="publish-tab">
      <div class="publish-container">
        <h3>Publicar Mensaje</h3>
        <div class="form-group">
          <label for="publish-topic">Tema:</label>
          <input type="text" id="publish-topic" placeholder="espbell/response">
        </div>
        <div class="form-group">
          <label for="publish-message">Mensaje:</label>
          <input type="text" id="publish-message" placeholder="Mensaje a publicar">
        </div>
        <button id="publish-btn">Publicar</button>
      </div>
    </div>
    
    <div class="footer">
      © 2025 EspBell MQTT Client • Desarrollado con Electron
    </div>
  </div>

  <!-- Notificación flotante -->
  <div class="notification" id="notification">
    <span id="notification-message" class="message"></span>
  </div>

  <script>
    // Referencias a elementos DOM
    const statusIndicator = document.getElementById('status-indicator');
    const connectionStatus = document.getElementById('connection-status');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const brokerUrl = document.getElementById('broker-url');
    const brokerUsername = document.getElementById('broker-username');
    const brokerPassword = document.getElementById('broker-password');
    const messageList = document.getElementById('message-list');
    const subscriptionTopic = document.getElementById('subscription-topic');
    const subscribeBtn = document.getElementById('subscribe-btn');
    const clearMessagesBtn = document.getElementById('clear-messages-btn');
    const publishTopic = document.getElementById('publish-topic');
    const publishMessage = document.getElementById('publish-message');
    const publishBtn = document.getElementById('publish-btn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const versionNumber = document.getElementById('version-number');
    const platformName = document.getElementById('platform-name');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    
    // Detector de tema oscuro/claro
    function applyTheme(isDarkMode) {
      if (isDarkMode) {
        document.body.classList.add('dark-theme');
        showNotification('Modo oscuro activado', 'success');
      } else {
        document.body.classList.remove('dark-theme');
        showNotification('Modo claro activado', 'success');
      }
    }
    
    // Escuchar cambios de tema del sistema
    if (window.themeAPI) {
      window.themeAPI.onThemeChanged((themeData) => {
        applyTheme(themeData.isDarkMode);
      });
    }
    
    // Detectar preferencia inicial de tema oscuro
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      applyTheme(true);
    }
    
    // Escuchar cambios de tema en el navegador
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      applyTheme(e.matches);
    });
    
    // Mostrar información de la aplicación
    if (window.electronInfo) {
      versionNumber.textContent = 'v' + window.electronInfo.appVersion;
      
      // Convertir el nombre de la plataforma a un formato más amigable
      let platform = window.electronInfo.platform;
      if (platform === 'win32') {
        platformName.textContent = 'Windows';
      } else if (platform === 'linux') {
        platformName.textContent = 'Linux';
      } else {
        platformName.textContent = platform;
      }
    }
    
    // Función para mostrar notificaciones
    function showNotification(message, type = 'success') {
      notification.classList.remove('success', 'error');
      notification.classList.add(type);
      notificationMessage.textContent = message;
      notification.classList.add('show');
      
      // Ocultar después de 3 segundos
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Funcionalidad de las pestañas
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        
        // Cambiar la pestaña activa
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Mostrar el contenido de la pestaña activa
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `${tabName}-tab`) {
            setTimeout(() => {
              content.classList.add('active');
            }, 50);
          }
        });
      });
    });
    
    // Manejar eventos de conexión MQTT
    connectBtn.addEventListener('click', () => {
      const url = brokerUrl.value.trim();
      const username = brokerUsername.value.trim();
      const password = brokerPassword.value.trim();
      
      if (!url) {
        showNotification('Por favor, ingresa la URL del broker', 'error');
        return;
      }
      
      // Enviar petición de conexión al proceso principal
      window.mqttAPI.connect({
        url,
        username: username || undefined,
        password: password || undefined
      });
      
      updateStatus('reconnecting', 'Conectando...');
    });
    
    disconnectBtn.addEventListener('click', () => {
      window.mqttAPI.disconnect();
    });
    
    // Manejar suscripciones
    subscribeBtn.addEventListener('click', () => {
      const topic = subscriptionTopic.value.trim();
      
      if (!topic) {
        showNotification('Por favor, ingresa un tema para suscribirte', 'error');
        return;
      }
      
      window.mqttAPI.subscribe(topic);
      addMessage('Sistema', `Suscrito al tema: ${topic}`);
      showNotification(`Suscrito a: ${topic}`);
    });
    
    // Manejar publicación de mensajes
    publishBtn.addEventListener('click', () => {
      const topic = publishTopic.value.trim();
      const message = publishMessage.value.trim();
      
      if (!topic || !message) {
        showNotification('Por favor, ingresa un tema y un mensaje', 'error');
        return;
      }
      
      window.mqttAPI.publish({
        topic,
        message
      });
      
      addMessage('Publicado', `${topic}: ${message}`);
      showNotification(`Mensaje publicado en: ${topic}`);
      publishMessage.value = '';
    });
    
    // Limpiar mensajes
    clearMessagesBtn.addEventListener('click', () => {
      messageList.innerHTML = '';
      showNotification('Mensajes borrados');
    });
    
    // Escuchar mensajes MQTT desde el proceso principal
    window.mqttAPI.onMessage((data) => {
      addMessage(data.topic, data.message);
    });
    
    // Escuchar cambios de estado MQTT
    window.mqttAPI.onStatusChange((status, message) => {
      updateStatus(status, message);
      
      // Mostrar notificaciones según el estado
      if (status === 'connected') {
        showNotification('Conectado al broker MQTT');
      } else if (status === 'disconnected') {
        showNotification('Desconectado del broker MQTT', 'error');
      } else if (status === 'error') {
        showNotification(message || 'Error de conexión', 'error');
      }
    });
    
    // Función para actualizar el indicador de estado
    function updateStatus(status, message) {
      statusIndicator.className = 'status-indicator';
      
      switch (status) {
        case 'connected':
          statusIndicator.classList.add('connected');
          connectionStatus.textContent = 'Conectado';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          break;
        case 'disconnected':
          statusIndicator.classList.add('disconnected');
          connectionStatus.textContent = 'Desconectado';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          break;
        case 'reconnecting':
          statusIndicator.classList.add('reconnecting');
          connectionStatus.textContent = message || 'Reconectando...';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          break;
        case 'error':
          statusIndicator.classList.add('disconnected');
          connectionStatus.textContent = message || 'Error de conexión';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          break;
      }
    }
    
    // Función para agregar un mensaje a la lista
    function addMessage(topic, message) {
      const messageItem = document.createElement('div');
      messageItem.className = 'message-item';
      
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      
      messageItem.innerHTML = `
        <span class="topic">${topic}:</span> ${message}
        <span class="timestamp">${timeString}</span>
      `;
      
      messageList.appendChild(messageItem);
      
      // Auto-scroll al final
      messageList.scrollTop = messageList.scrollHeight;
    }
    
    // Inicializar el estado
    updateStatus('disconnected');
    
    // Agregar mensaje inicial
    addMessage('Sistema', 'Cliente MQTT iniciado. Conecta a un broker para comenzar.');
    
    // Limpiar listeners al cerrar la ventana
    window.addEventListener('beforeunload', () => {
      if (window.mqttAPI && window.mqttAPI.removeAllListeners) {
        window.mqttAPI.removeAllListeners();
      }
    });
  </script>
</body>
</html>
