<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>EspBell Timbre</title>
  <style>
    :root {
      /* Variables de color en estilo Apple - Tema Claro */
      --apple-bg: #f5f5f7;
      --apple-panel: rgba(255, 255, 255, 0.8);
      --apple-panel-solid: #ffffff;
      --apple-text: #1d1d1f;
      --apple-text-secondary: #86868b;
      --apple-accent: #0071e3;
      --apple-accent-hover: #0077ed;
      --apple-accent-light: rgba(0, 113, 227, 0.1);
      --apple-border: rgba(0, 0, 0, 0.1);
      --apple-success: #34c759;
      --apple-warning: #ff9f0a;
      --apple-error: #ff3b30;
      --apple-inactive: #ebebeb;
      --apple-shadow: rgba(0, 0, 0, 0.08);
      --apple-shadow-strong: rgba(0, 0, 0, 0.15);
      --apple-radius: 12px;
      --apple-radius-button: 980px;
      --apple-transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    /* Variables de tema oscuro */
    .dark-theme {
      --apple-bg: #1d1d1f;
      --apple-panel: rgba(40, 40, 45, 0.8);
      --apple-panel-solid: #2a2a2e;
      --apple-text: #f5f5f7;
      --apple-text-secondary: #aaaaae;
      --apple-accent: #0a84ff;
      --apple-accent-hover: #409cff;
      --apple-accent-light: rgba(10, 132, 255, 0.15);
      --apple-border: rgba(255, 255, 255, 0.1);
      --apple-inactive: #3a3a3c;
      --apple-shadow: rgba(0, 0, 0, 0.3);
      --apple-shadow-strong: rgba(0, 0, 0, 0.5);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--apple-bg);
      background-image: linear-gradient(to bottom, var(--apple-bg), var(--apple-bg) 95%);
      color: var(--apple-text);
      margin: 0;
      padding: 30px;
      transition: var(--apple-transition);
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .theme-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .theme-label {
      font-size: 14px;
      color: var(--apple-text);
    }
    
    h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }
    
    /* Estilo para el interruptor de tema */
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }
    
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .theme-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--apple-inactive);
      transition: var(--apple-transition);
      border-radius: 28px;
    }
    
    .theme-slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: var(--apple-transition);
      border-radius: 50%;
      box-shadow: 0 2px 4px var(--apple-shadow-strong);
    }
    
    input:checked + .theme-slider {
      background-color: var(--apple-accent);
    }
    
    input:checked + .theme-slider:before {
      transform: translateX(24px);
    }
    
    /* Estilos para las pesta침as */
    .tab-container {
      margin-bottom: 20px;
      width: 100%;
      overflow-x: auto;
    }
    
    .tabs {
      display: flex;
      gap: 2px;
      background-color: var(--apple-inactive);
      border-radius: var(--apple-radius);
      padding: 4px;
      width: fit-content;
      min-width: 300px;
    }
    
    .tab {
      padding: 8px 16px;
      border-radius: var(--apple-radius);
      cursor: pointer;
      transition: var(--apple-transition);
      font-weight: 500;
      white-space: nowrap;
    }
    
    .tab.active {
      background-color: var(--apple-panel-solid);
      box-shadow: 0 2px 6px var(--apple-shadow);
    }
    
    /* Contenido de las pesta침as */
    .tab-content {
      display: none;
      background-color: var(--apple-panel);
      border-radius: var(--apple-radius);
      padding: 24px;
      box-shadow: 0 8px 16px var(--apple-shadow);
      margin-top: 20px;
      flex: 1;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Estilos para la secci칩n de espera */
    .waiting-section {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      max-height: 500px;
      overflow: auto;
    }
    
    .status-indicator {
      margin-bottom: 20px;
      font-size: 16px;
      color: var(--apple-text-secondary);
    }
    
    .status-indicator.connected {
      color: var(--apple-success);
    }
    
    .status-indicator.error {
      color: var(--apple-error);
    }
    
    .waiting-message {
      font-size: 24px;
      margin-bottom: 40px;
    }
    
    .doorbell-icon {
      width: 120px;
      height: 120px;
      fill: var(--apple-accent);
      margin-bottom: 30px;
      transition: var(--apple-transition);
    }
    
    @media (max-width: 600px) {
      body {
        padding: 15px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      .waiting-message {
        font-size: 20px;
        margin-bottom: 20px;
      }
      
      .doorbell-icon {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
      }
      
      .tab {
        padding: 6px 12px;
        font-size: 14px;
      }
      
      .tab-content {
        padding: 15px;
      }
    }
    
    /* Alerta del timbre */
    .doorbell-alert {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 59, 48, 0.9);
      z-index: 100;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      animation: pulse 1.5s infinite;
      padding: 20px;
      text-align: center;
    }
    
    .doorbell-alert h2 {
      font-size: 48px;
      margin-bottom: 20px;
    }
    
    .doorbell-alert p {
      font-size: 24px;
      margin-bottom: 40px;
    }
    
    .dismiss-btn {
      background-color: white;
      color: #ff3b30;
      border: none;
      padding: 12px 30px;
      font-size: 18px;
      border-radius: var(--apple-radius-button);
      cursor: pointer;
      font-weight: bold;
      transition: var(--apple-transition);
    }
    
    .dismiss-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes pulse {
      0% {
        background-color: rgba(255, 59, 48, 0.7);
      }
      50% {
        background-color: rgba(255, 59, 48, 0.9);
      }
      100% {
        background-color: rgba(255, 59, 48, 0.7);
      }
    }
    
    @media (max-width: 600px) {
      .doorbell-alert h2 {
        font-size: 36px;
        margin-bottom: 15px;
      }
      
      .doorbell-alert p {
        font-size: 18px;
        margin-bottom: 30px;
      }
      
      .dismiss-btn {
        padding: 10px 24px;
        font-size: 16px;
      }
    }
    
    /* Estilos para la secci칩n de chat */
    .chat-container {
      display: flex;
      height: 100%;
      border: 1px solid var(--apple-border);
      border-radius: var(--apple-radius);
      overflow: hidden;
      background: var(--apple-panel-solid);
    }

    .chat-sidebar {
      width: 200px;
      background: var(--apple-panel);
      border-right: 1px solid var(--apple-border);
      padding: 0;
      flex-shrink: 0;
    }

    .chat-sidebar h3 {
      padding: 15px;
      margin: 0;
      background: var(--apple-panel-solid);
      border-bottom: 1px solid var(--apple-border);
      font-size: 16px;
      font-weight: 600;
    }

    .contact-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      cursor: pointer;
      transition: var(--apple-transition);
      border-bottom: 1px solid var(--apple-border);
    }

    .contact-item:hover {
      background: var(--apple-accent-light);
    }

    .contact-item.active {
      background: var(--apple-accent);
      color: white;
    }

    .contact-name {
      font-weight: 500;
      font-size: 14px;
    }

    .unread-count {
      background: var(--apple-error);
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 11px;
      min-width: 16px;
      text-align: center;
      display: none;
    }

    .unread-count.show {
      display: block;
    }

    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: var(--apple-panel);
      border-bottom: 1px solid var(--apple-border);
    }

    .chat-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .connection-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 12px;
      background: var(--apple-error);
      color: white;
    }

    .connection-status.connected {
      background: var(--apple-success);
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: var(--apple-bg);
    }

    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 12px;
      word-wrap: break-word;
      position: relative;
      animation: fadeInMessage 0.3s ease-out;
      transform-origin: bottom;
    }

    @keyframes fadeInMessage {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message.sent {
      align-self: flex-end;
      background: var(--apple-accent);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.received {
      align-self: flex-start;
      background: var(--apple-panel-solid);
      color: var(--apple-text);
      border: 1px solid var(--apple-border);
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }

    .message.received .message-time {
      text-align: left;
    }

    .chat-input {
      display: flex;
      padding: 12px;
      gap: 8px;
      background: var(--apple-panel);
      border-top: 1px solid var(--apple-border);
    }

    .chat-input input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--apple-border);
      border-radius: 20px;
      background: var(--apple-panel-solid);
      color: var(--apple-text);
      font-size: 14px;
      outline: none;
      transition: var(--apple-transition);
    }

    .chat-input input:focus {
      border-color: var(--apple-accent);
      box-shadow: 0 0 0 2px var(--apple-accent-light);
      transform: scale(1.02);
    }

    .chat-input button {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      min-width: 60px;
      transition: all 0.2s ease;
    }

    .chat-input button:not(:disabled):hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px var(--apple-shadow);
    }

    .chat-input button:not(:disabled):active {
      transform: scale(0.98);
    }

    /* Responsive para pantallas peque침as */
    @media (max-width: 600px) {
      .chat-sidebar {
        width: 150px;
      }

      .contact-item {
        padding: 10px 12px;
      }

      .contact-name {
        font-size: 13px;
      }

      .message {
        max-width: 85%;
      }

      .chat-input {
        padding: 8px;
      }
    }

    /* Mensaje de bienvenida */
    .welcome-message {
      text-align: center;
      color: var(--apple-text-secondary);
      font-style: italic;
      padding: 20px;
      opacity: 0.7;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 0.7; }
    }

    /* Mejoras para el contador de mensajes no le칤dos */
    .unread-count {
      animation: bounce 0.5s ease-out;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-4px);
      }
      60% {
        transform: translateY(-2px);
      }
    }

    /* Hover effects para contactos */
    .contact-item {
      position: relative;
      overflow: hidden;
    }

    .contact-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .contact-item:hover::before {
      left: 100%;
    }
  </style>
</head>
<body>
  <header>
    <h1>EspBell Timbre</h1>
    <div class="theme-control">
      <span class="theme-label">Tema Oscuro</span>
      <label class="theme-switch">
        <input type="checkbox" id="theme-toggle">
        <span class="theme-slider"></span>
      </label>
    </div>
  </header>
  
  <div class="tab-container">
    <div class="tabs">
      <div class="tab" data-tab="waiting">Esperando Timbre</div>
      <div class="tab active" data-tab="chat">Chat</div>
    </div>
  </div>
  
  <div id="waiting-tab-content" class="tab-content">
    <div class="waiting-section">
      <div class="status-indicator" id="mqtt-status">Conectando al servidor...</div>
      
      <svg class="doorbell-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M10,21H14A2,2 0 0,1 12,23A2,2 0 0,1 10,21M21,19V20H3V19L5,17V11C5,7.9 7.03,5.17 10,4.29C10,4.19 10,4.1 10,4A2,2 0 0,1 12,2A2,2 0 0,1 14,4C14,4.1 14,4.19 14,4.29C16.97,5.17 19,7.9 19,11V17L21,19M17,11A5,5 0 0,0 12,6A5,5 0 0,0 7,11V18H17V11M19.75,3.19L18.33,4.61C20.04,6.3 21,8.6 21,11H23C23,8.07 21.84,5.25 19.75,3.19M1,11H3C3,8.6 3.96,6.3 5.67,4.61L4.25,3.19C2.16,5.25 1,8.07 1,11Z"/>
      </svg>
      
      <div class="waiting-message">
        Esperando que alguien toque el timbre...
      </div>
    </div>
  </div>
  
  <div id="chat-tab-content" class="tab-content active">
    <div class="chat-container">
      <!-- Men칰 lateral -->
      <div class="chat-sidebar">
        <h3>Contactos</h3>
        <div class="contact-list">
          <div class="contact-item active" data-contact="Albert">
            <span class="contact-name">Albert</span>
            <span class="unread-count" id="unread-Albert">0</span>
          </div>
          <div class="contact-item" data-contact="Ale">
            <span class="contact-name">Ale</span>
            <span class="unread-count" id="unread-Ale">0</span>
          </div>
          <div class="contact-item" data-contact="Mama">
            <span class="contact-name">Mama</span>
            <span class="unread-count" id="unread-Mama">0</span>
          </div>
        </div>
      </div>

      <!-- 츼rea de chat -->
      <div class="chat-main">
        <div class="chat-header">
          <h3 id="current-chat-name">Albert</h3>
          <span class="connection-status" id="chat-connection-status">Desconectado</span>
        </div>

        <div class="chat-messages" id="chat-messages">
          <!-- Los mensajes aparecer치n aqu칤 -->
        </div>

        <div class="chat-input">
          <input type="text" id="chat-message-input" placeholder="Escribe un mensaje..." maxlength="200">
          <button id="chat-send-btn" disabled>Enviar</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="doorbell-alert" id="doorbell-alert">
    <h2>춰TIMBRE!</h2>
    <p id="doorbell-message">Alguien est치 en la puerta</p>
    <button class="dismiss-btn" id="dismiss-btn">ENTENDIDO</button>
  </div>
  
  <script>
    // DOM Elements
    const themeToggle = document.getElementById('theme-toggle');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const mqttStatus = document.getElementById('mqtt-status');
    const doorbellAlert = document.getElementById('doorbell-alert');
    const doorbellMessage = document.getElementById('doorbell-message');
    const dismissBtn = document.getElementById('dismiss-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatMessageInput = document.getElementById('chat-message-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const currentChatName = document.getElementById('current-chat-name');
    const chatConnectionStatus = document.getElementById('chat-connection-status');
    
    // Check system dark mode preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark-theme');
      themeToggle.checked = true;
    }
    
    // Event Listeners
    themeToggle.addEventListener('change', () => {
      document.body.classList.toggle('dark-theme');
      window.themeAPI.setTheme(themeToggle.checked);
    });
    
    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = `${tab.dataset.tab}-tab-content`;
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // MQTT Status Listener
    window.mqttAPI.onStatusChange((status, message) => {
      mqttStatus.className = 'status-indicator';
      
      switch (status) {
        case 'connected':
          mqttStatus.textContent = 'Conectado al servidor';
          mqttStatus.classList.add('connected');
          break;
        case 'disconnected':
          mqttStatus.textContent = 'Desconectado del servidor';
          break;
        case 'reconnecting':
          mqttStatus.textContent = 'Reconectando...';
          break;
        case 'error':
          mqttStatus.textContent = `Error: ${message || 'Desconocido'}`;
          mqttStatus.classList.add('error');
          break;
        default:
          mqttStatus.textContent = 'Estado desconocido';
      }
    });
    
    // Doorbell Alert Listener
    window.mqttAPI.onDoorbellAlert((message) => {
      // Detener cualquier sonido previo y reiniciar
      stopAlertSound();
      
      // Show the alert
      doorbellAlert.style.display = 'flex';
      
      // Set message if available
      if (message && message !== 'on' && message !== '1') {
        doorbellMessage.textContent = message;
      } else {
        doorbellMessage.textContent = 'Alguien est치 en la puerta';
      }
      
      // Play notification sound
      playAlertSound();
    });
    
    // Dismiss button
    dismissBtn.addEventListener('click', () => {
      doorbellAlert.style.display = 'none';
      stopAlertSound();
    });
    
    // Chat functionality
    let currentChatContact = 'Albert';
    let chatHistory = {
      Albert: [],
      Ale: [],
      Mama: []
    };
    
    // Load chat history from localStorage on startup
    function loadChatHistoryFromStorage() {
      try {
        const saved = localStorage.getItem('espbell-chat-history');
        if (saved) {
          const parsedHistory = JSON.parse(saved);
          // Convert timestamp strings back to Date objects
          Object.keys(parsedHistory).forEach(contact => {
            parsedHistory[contact].forEach(msg => {
              msg.timestamp = new Date(msg.timestamp);
            });
          });
          chatHistory = { ...chatHistory, ...parsedHistory };
        }
      } catch (error) {
        console.error('Error loading chat history:', error);
      }
    }
    
    // Save chat history to localStorage
    function saveChatHistoryToStorage() {
      try {
        localStorage.setItem('espbell-chat-history', JSON.stringify(chatHistory));
      } catch (error) {
        console.error('Error saving chat history:', error);
      }
    }
    
    // Initialize chat history on page load
    loadChatHistoryFromStorage();
    
    // Load initial chat for Albert
    setTimeout(() => {
      loadChatHistory(currentChatContact);
    }, 100);
    
    // Contact selection
    document.querySelectorAll('.contact-item').forEach(contact => {
      contact.addEventListener('click', function() {
        // Remove active class from all contacts
        document.querySelectorAll('.contact-item').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked contact
        this.classList.add('active');
        
        // Update current chat
        currentChatContact = this.dataset.contact;
        currentChatName.textContent = currentChatContact;
        
        // Clear unread count
        const unreadElement = document.getElementById(`unread-${currentChatContact}`);
        unreadElement.textContent = '0';
        unreadElement.classList.remove('show');
        
        // Load chat history
        loadChatHistory(currentChatContact);
      });
    });
    
    // Enable/disable send button based on input
    chatMessageInput.addEventListener('input', () => {
      const hasText = chatMessageInput.value.trim().length > 0;
      const isConnected = chatConnectionStatus.classList.contains('connected');
      chatSendBtn.disabled = !(hasText && isConnected);
    });
    
    // Send message on Enter key
    chatMessageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !chatSendBtn.disabled) {
        sendChatMessage();
      }
    });
    
    // Chat message send button
    chatSendBtn.addEventListener('click', sendChatMessage);
    
    function sendChatMessage() {
      const message = chatMessageInput.value.trim();
      
      if (!message) {
        return;
      }
      
      // Create unique header with timestamp to identify messages from this app
      const timestamp = Date.now();
      const messageWithHeader = `[ESPBELL_APP_${timestamp}]:${message}`;
      
      // Send message via MQTT with header
      window.mqttAPI.publish({
        topic: `casa/chat/${currentChatContact}`,
        message: messageWithHeader
      });
      
      // Add message to chat history and display (without header)
      const messageData = {
        type: 'sent',
        message: message,
        timestamp: new Date()
      };
      
      chatHistory[currentChatContact].push(messageData);
      addMessageToChat(messageData);
      saveChatHistoryToStorage();
      
      // Clear input
      chatMessageInput.value = '';
      chatSendBtn.disabled = true;
    }
    
    function addMessageToChat(messageData) {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${messageData.type}`;
      
      const messageText = document.createElement('div');
      messageText.textContent = messageData.message;
      
      const messageTime = document.createElement('div');
      messageTime.className = 'message-time';
      messageTime.textContent = formatTime(messageData.timestamp);
      
      messageElement.appendChild(messageText);
      messageElement.appendChild(messageTime);
      
      // Append message to chat
      chatMessages.appendChild(messageElement);
      
      // Scroll to bottom with smooth animation
      requestAnimationFrame(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }
    
    function loadChatHistory(contact) {
      // Clear current messages
      chatMessages.innerHTML = '';
      
      // Load messages for the selected contact
      if (chatHistory[contact] && chatHistory[contact].length > 0) {
        chatHistory[contact].forEach(messageData => {
          addMessageToChat(messageData);
        });
      } else {
        // Show welcome message if no chat history
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'welcome-message';
        welcomeMsg.textContent = `Inicia una conversaci칩n con ${contact}`;
        welcomeMsg.style.cssText = `
          text-align: center;
          color: var(--apple-text-secondary);
          font-style: italic;
          padding: 20px;
          opacity: 0.7;
        `;
        chatMessages.appendChild(welcomeMsg);
      }
    }
    
    function formatTime(date) {
      return date.toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function updateUnreadCount(contact) {
      if (contact !== currentChatContact) {
        const unreadElement = document.getElementById(`unread-${contact}`);
        let count = parseInt(unreadElement.textContent) || 0;
        count++;
        unreadElement.textContent = count.toString();
        unreadElement.classList.add('show');
        
        // Play chat notification sound
        playChatNotificationSound();
        
        // Show browser notification if supported
        showChatNotification(contact);
      }
    }
    
    // Chat notification sound (different from doorbell)
    function playChatNotificationSound() {
      try {
        // Create a short, gentle notification sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (error) {
        console.log('Could not play chat notification sound:', error);
      }
    }
    
    // Show browser notification for chat messages
    function showChatNotification(contact) {
      if ('Notification' in window) {
        if (Notification.permission === 'granted') {
          new Notification(`Nuevo mensaje de ${contact}`, {
            body: 'Tienes un nuevo mensaje en EspBell Chat',
            icon: './public/icon.png',
            tag: 'espbell-chat'
          });
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              showChatNotification(contact);
            }
          });
        }
      }
    }
    
    // Update chat connection status based on main MQTT status
    window.mqttAPI.onStatusChange((status, message) => {
      // Update main status
      mqttStatus.className = 'status-indicator';
      
      // Update chat connection status
      chatConnectionStatus.className = 'connection-status';
      
      switch (status) {
        case 'connected':
          mqttStatus.textContent = 'Conectado al servidor';
          mqttStatus.classList.add('connected');
          chatConnectionStatus.textContent = 'Conectado';
          chatConnectionStatus.classList.add('connected');
          // Enable send button if there's text in input
          chatSendBtn.disabled = !chatMessageInput.value.trim();
          break;
        case 'disconnected':
          mqttStatus.textContent = 'Desconectado del servidor';
          chatConnectionStatus.textContent = 'Desconectado';
          chatSendBtn.disabled = true;
          break;
        case 'reconnecting':
          mqttStatus.textContent = 'Reconectando...';
          chatConnectionStatus.textContent = 'Reconectando...';
          chatSendBtn.disabled = true;
          break;
        case 'error':
          mqttStatus.textContent = `Error: ${message || 'Desconocido'}`;
          mqttStatus.classList.add('error');
          chatConnectionStatus.textContent = 'Error';
          chatSendBtn.disabled = true;
          break;
        default:
          mqttStatus.textContent = 'Estado desconocido';
          chatConnectionStatus.textContent = 'Desconocido';
          chatSendBtn.disabled = true;
      }
    });
    
    // Doorbell Alert Listener
    window.mqttAPI.onDoorbellAlert((message) => {
      // Detener cualquier sonido previo y reiniciar
      stopAlertSound();
      
      // Show the alert
      doorbellAlert.style.display = 'flex';
      
      // Set message if available
      if (message && message !== 'on' && message !== '1') {
        doorbellMessage.textContent = message;
      } else {
        doorbellMessage.textContent = 'Alguien est치 en la puerta';
      }
      
      // Play notification sound
      playAlertSound();
    });
    
    // Dismiss button
    dismissBtn.addEventListener('click', () => {
      doorbellAlert.style.display = 'none';
      stopAlertSound();
    });
    
    // Function to play alert sound
    let alertAudio;
    
    function playAlertSound() {
      // Crear un nuevo objeto de audio si no existe
      if (!alertAudio) {
        alertAudio = new Audio('data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADVghQAAAAA//uQZAUAB1WI0PZugAAAAAoQwAAAEk3nRd2qAAAAACiDgAAAAAAABCqEEQRLCgwpBGMlJkIz8jKhGvj4k6jzRnqasNKIeoh5gI7BJaC1A1AoNBjJgbyApVS4IDlZgDU5WUAxEKDNmmALHzZp0Fkz1FMTmGFl1FMEyodIavcCAUHDWrKAIA4aa2oCgILEBupZgHvAhEBcZ6joQBxS76AgccrFlczBvKLC0QI2cBoCFvfTDAo7eoOQInqDPBtvrDEZBNYN5xwNwxQRfw8ZQ5wQVLvO8OYU+mHvFLlDh05Mdg7BT6YrRPpCBznMB2r//xKJjyyOh+cImr2/4doscwD6neZjuZR4AgAABYAAAABy1xcdQtxYBYYZdifkUDgzzXaXn98Z0oi9ILU5mBjFANmRwlVJ3/6jYDAmxaiDG3/6xjQQCCKkRb/6kg/wW+kSJ5//rLobkLSiKmqP/0ikJuDaSaSf/6JiLYLEYnW/+kXg1WRVJL/9EmQ1YZIsv/6Qzwy5qk7/+tEU0nkls3/zIUMPKNX/6yZLf+kFgAfgGyLFAUwY//uQZAUABcd5UiNPVXAAAApAAAAAE0VZQKw9ISAAACgAAAAAVQIygIElVrFkBS+Jhi+EAuu+lKAkYUEIsmEAEoMeDmCETMvfSHTGkF5RWH7kz/ESHWPAq/kcCRhqBtMdokPdM7vil7RG98A2sc7zO6ZvTdM7pmOUAZTnJW+NXxqmd41dqJ6mLTXxrPpnV8avaIf5SvL7pndPvPpndJR9Kuu8fePvuiuhorgWjp7Mf/PRjxcFCPDkW31srioCExivv9lcwKEaHsf/7ow2Fl1T/9RkXgEhYElAoCLFtMArxwivDJJ+bR1HTKJdlEoTELCIqgEwVGSQ+hIm0NbK8WXcTEI0UPoa2NbG4y2K00JEWbZavJXkYaqo9CRHS55FcZTjKEk3NKoCYUnSQ0rWxrZbFKbKIhOKPZe1cJKzZSaQrIyULHDZmV5K4xySsDRKWOruanGtjLJXFEmwaIbDLX0hIPBUQPVFVkQkDoUNfSoDgQGKPekoxeGzA4DUvnn4bxzcZrtJyipKfPNy5w+9lnXwgqsiyHNeSVpemw4bWb9psYeq//uQZBoABQt4yMVxYAIAAAkQoAAAHvYpL5m6AAgAACXDAAAAD59jblTirQe9upFsmZbpMudy7Lz1X1DYsxOOSWpfPqNX2WqktK0DMvuGwlbNj44TleLPQ+Gsfb+GOWOKJoIrWb3cIMeeON6lz2umTqMXV8Mj30yWPpjoSa9ujK8SyeJP5y5mOW1D6hvLepeveEAEDo0mgCRClOEgANv3B9a6fikgUSu/DmAMATrGx7nng5p5iimPNZsfQLYB2sDLIkzRKZOHGAaUyDcpFBSLG9MCQALgAIgQs2YunOszLSAyQYPVC2YdGGeHD2dTdJk1pAHGAWDjnkcLKFymS3RQZTInzySoBwMG0QueC3gMsCEYxUqlrcxK6k1LQQcsmyYeQPdC2YfuGPASCBkcVMQQqpVJshui1tkXQJQV0OXGAZMXSOEEBRirXbVRQW7ugq7IM7rPWSZyDlM3IuNEkxzCOJ0ny2ThNkyRai1b6ev//3dzNGzNb//4uAvHT5sURcZCFcuKLhOFs8mLAAEAt4UWAAIABAAAAAB4qbHo0tIjVkUU//uQZAwABfSFz3ZqQAAAAAngwAAAE1HjMp2qAAAAACZDgAAAD5UkTE1UgZEUExqYynN1qZvqIOREEFmBcJQkwdxiFtw0qEOkGYfRDifBui9MQg4QAHAqWtAWHoCxu1Yf4VfWLPIM2mHDFsbQEVGwyqQoQcwnfHeIkNt9YnkiaS1oizycqJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=');
      }
      
      // Configurar para reproducci칩n en bucle
      alertAudio.loop = true;
      
      // Reproducir el sonido
      alertAudio.play();
    }
    
    function stopAlertSound() {
      if (alertAudio) {
        alertAudio.pause();
        alertAudio.currentTime = 0;
      }
    }
    
    // Tambi칠n escuchar mensajes en el topic casa/timbre y chat
    window.mqttAPI.onMessage((data) => {
      if (data.topic === 'casa/timbre') {
        // Detener cualquier sonido previo y reiniciar
        stopAlertSound();
        
        // Show the alert
        doorbellAlert.style.display = 'flex';
        
        // Set message if available
        if (data.message && data.message !== 'on' && data.message !== '1') {
          doorbellMessage.textContent = data.message;
        } else {
          doorbellMessage.textContent = 'Alguien est치 en la puerta';
        }
        
        // Play notification sound
        playAlertSound();
      } else if (data.topic.startsWith('casa/chat/')) {
        // Handle chat messages
        const contact = data.topic.split('/')[2]; // Extract contact name from topic
        
        if (['Albert', 'Ale', 'Mama'].includes(contact)) {
          // Check if message is from this app (has our unique header)
          if (data.message.startsWith('[ESPBELL_APP_') && data.message.includes(']:')) {
            // This is a message sent from this app, ignore it
            console.log('Ignorando mensaje propio:', data.message);
            return;
          }
          
          // Process message content - handle Telegram format [TELEGRAM_@JoyaAP]:message
          let messageContent = data.message;
          if (data.message.startsWith('[TELEGRAM_@') && data.message.includes(']:')) {
            // Extract content after the colon for Telegram messages
            const colonIndex = data.message.indexOf(']:');
            if (colonIndex !== -1) {
              messageContent = data.message.substring(colonIndex + 2);
            }
          }
          
          // This is a received message from external source
          const messageData = {
            type: 'received',
            message: messageContent,
            timestamp: new Date()
          };
          
          console.log('Mensaje recibido de', contact + ':', messageContent);
          
          chatHistory[contact].push(messageData);
          saveChatHistoryToStorage();
          
          // If this is the current chat, display the message
          if (contact === currentChatContact) {
            addMessageToChat(messageData);
          } else {
            // Update unread count and show notification
            updateUnreadCount(contact);
          }
        }
      }
    });
    
    // Escuchar eventos espec칤ficos de mensajes de chat para mostrar la ventana
    window.mqttAPI.onChatMessageReceived((data) => {
      console.log('游댒 Mensaje de chat recibido, la ventana ya deber칤a estar visible');
      
      // Reproducir sonido de notificaci칩n de chat (m치s suave que el timbre)
      playChatNotificationSound();
      
      // Mostrar notificaci칩n del navegador si est치 disponible
      const contact = data.user;
      if (contact && contact !== currentChatContact) {
        showChatNotification(contact);
      }
    });
    
    // Debug function to simulate external messages (for testing)
    window.simulateExternalMessage = function(contact, message) {
      // Simulate receiving a message from external source (without header)
      const fakeData = {
        topic: `casa/chat/${contact}`,
        message: message
      };
      
      // Process message content - handle Telegram format [TELEGRAM_@JoyaAP]:message
      let messageContent = message;
      if (message.startsWith('[TELEGRAM_@') && message.includes(']:')) {
        // Extract content after the colon for Telegram messages
        const colonIndex = message.indexOf(']:');
        if (colonIndex !== -1) {
          messageContent = message.substring(colonIndex + 2);
        }
      }
      
      // Process as if it came from MQTT
      if (['Albert', 'Ale', 'Mama'].includes(contact)) {
        const messageData = {
          type: 'received',
          message: messageContent,
          timestamp: new Date()
        };
        
        chatHistory[contact].push(messageData);
        saveChatHistoryToStorage();
        
        if (contact === currentChatContact) {
          addMessageToChat(messageData);
        } else {
          updateUnreadCount(contact);
        }
      }
    };
    
    // Debug info
    console.log('EspBell Chat inicializado. Para probar mensajes externos usar:');
    console.log('simulateExternalMessage("Albert", "Hola desde el exterior")');
    console.log('simulateExternalMessage("Albert", "[TELEGRAM_@JoyaAP]:Mensaje desde Telegram")');
    
    // Listen for theme changes from the main process
    window.themeAPI.onThemeChanged((themeData) => {
      if (themeData.isDarkMode) {
        document.body.classList.add('dark-theme');
        themeToggle.checked = true;
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.checked = false;
      }
    });
    
    // Cleanup listeners when window unloads
    window.addEventListener('beforeunload', () => {
      window.mqttAPI.removeAllListeners();
      window.themeAPI.removeThemeListeners();
      window.updateAPI.removeUpdateListeners();
    });
    
    // Escuchar actualizaciones disponibles
    window.updateAPI.onUpdateAvailable((updateInfo) => {
      const updateNotification = document.createElement('div');
      updateNotification.className = 'update-notification';
      updateNotification.innerHTML = `
        <div class="update-notification-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
            <path d="M21,10.12H14.22L16.96,7.3C14.23,4.6 9.81,4.5 7.08,7.2C4.35,9.91 4.35,14.28 7.08,17C9.81,19.7 14.23,19.7 16.96,17C18.32,15.65 19,14.08 19,12.1H21C21,14.08 20.12,16.65 18.36,18.39C14.85,21.87 9.15,21.87 5.64,18.39C2.14,14.92 2.11,9.28 5.62,5.81C9.13,2.34 14.76,2.34 18.27,5.81L21,3V10.12M12.5,8V12.25L16,14.33L15.28,15.54L11,13V8H12.5Z"></path>
          </svg>
          Nueva versi칩n disponible
        </div>
        <div class="update-notification-content">
          Hay una nueva versi칩n (${updateInfo.version}) disponible para descargar.
        </div>
        <div class="update-notification-actions">
          <button class="update-notification-dismiss" id="update-dismiss">Luego</button>
          <button class="update-notification-button" id="update-download">Descargar</button>
        </div>
      `;
      
      document.body.appendChild(updateNotification);
      
      // Mostrar la notificaci칩n con animaci칩n
      setTimeout(() => {
        updateNotification.style.display = 'block';
      }, 1000);
      
      // Configurar botones
      document.getElementById('update-dismiss').addEventListener('click', () => {
        updateNotification.style.display = 'none';
      });
      
      document.getElementById('update-download').addEventListener('click', () => {
        window.updateAPI.openUpdateLink(updateInfo.releaseUrl);
        updateNotification.style.display = 'none';
      });
    });
  </script>
  
  
  <!-- Estilos CSS para la notificaci칩n de actualizaci칩n -->
  <style>
    .update-notification {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: var(--apple-panel-solid);
      border-radius: var(--apple-radius);
      box-shadow: 0 4px 12px var(--apple-shadow-strong);
      padding: 15px;
      width: 300px;
      z-index: 1000;
      border: 1px solid var(--apple-border);
      animation: slide-in 0.3s ease-out;
    }
    
    @keyframes slide-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .update-notification-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--apple-text);
      display: flex;
      align-items: center;
    }
    
    .update-notification-title svg {
      margin-right: 8px;
      fill: var(--apple-accent);
    }
    
    .update-notification-content {
      font-size: 14px;
      margin-bottom: 15px;
      color: var(--apple-text-secondary);
    }
    
    .update-notification-actions {
      display: flex;
      justify-content: flex-end;
    }
    
    .update-notification-button {
      background-color: var(--apple-accent);
      color: white;
      border: none;
      border-radius: var(--apple-radius-button);
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--apple-transition);
    }
    
    .update-notification-button:hover {
      background-color: var(--apple-accent-hover);
    }
    
    .update-notification-dismiss {
      background-color: transparent;
      color: var(--apple-text-secondary);
      border: none;
      margin-right: 10px;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 16px;
    }
    
    .update-notification-dismiss:hover {
      color: var(--apple-text);
    }
  </style>
</body>
</html>
